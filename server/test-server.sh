#!/bin/bash

echo "üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è SmartCoach Backend"
echo "================================"
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ .env
if [ ! -f .env ]; then
    echo "‚ùå –§–∞–π–ª .env –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!"
    echo "üìù –°—Ç–≤–æ—Ä—é—é .env –∑ .env.example..."
    cp .env.example .env
    echo "‚ö†Ô∏è  –ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –≤ .env —Ñ–∞–π–ª—ñ"
    echo ""
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó
echo "1Ô∏è‚É£  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ TypeScript –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó..."
npm run build
if [ $? -eq 0 ]; then
    echo "‚úÖ TypeScript –∫–æ–º–ø—ñ–ª—é—î—Ç—å—Å—è —É—Å–ø—ñ—à–Ω–æ"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó TypeScript"
    exit 1
fi
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–Ω—Ç–µ—Ä–∞
echo "2Ô∏è‚É£  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ª—ñ–Ω—Ç–µ—Ä–∞..."
npm run lint
if [ $? -eq 0 ]; then
    echo "‚úÖ –õ—ñ–Ω—Ç–µ—Ä –Ω–µ –∑–Ω–∞–π—à–æ–≤ –ø–æ–º–∏–ª–æ–∫"
else
    echo "‚ö†Ô∏è  –õ—ñ–Ω—Ç–µ—Ä –∑–Ω–∞–π—à–æ–≤ –ø–æ–º–∏–ª–∫–∏ (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –∑–∞–ø—É—Å–∫—É)"
fi
echo ""

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –≤ —Ñ–æ–Ω—ñ
echo "3Ô∏è‚É£  –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞..."
npm run dev &
SERVER_PID=$!
echo "‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–µ—Ä–∞ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ health check
echo "4Ô∏è‚É£  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ health check endpoint..."
HEALTH_RESPONSE=$(curl -s http://localhost:3000/health)
if echo "$HEALTH_RESPONSE" | grep -q "success"; then
    echo "‚úÖ Health check –ø—Ä–∞—Ü—é—î!"
    echo "üìÑ –í—ñ–¥–ø–æ–≤—ñ–¥—å: $HEALTH_RESPONSE"
else
    echo "‚ùå Health check –Ω–µ –ø—Ä–∞—Ü—é—î"
    echo "üìÑ –í—ñ–¥–ø–æ–≤—ñ–¥—å: $HEALTH_RESPONSE"
fi
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ 404
echo "5Ô∏è‚É£  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±—Ä–æ–±–∫–∏ 404..."
NOT_FOUND_RESPONSE=$(curl -s http://localhost:3000/api/nonexistent)
if echo "$NOT_FOUND_RESPONSE" | grep -q "–Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ"; then
    echo "‚úÖ 404 handler –ø—Ä–∞—Ü—é—î!"
else
    echo "‚ö†Ô∏è  404 handler –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
fi
echo ""

# –ó—É–ø–∏–Ω–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
echo "6Ô∏è‚É£  –ó—É–ø–∏–Ω–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞..."
kill $SERVER_PID 2>/dev/null
echo "‚úÖ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üí° –î–ª—è –ø–æ–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å—Ç–∏: npm run dev"

